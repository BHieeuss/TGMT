{% extends "base.html" %} {% block title %}Tạo ca điểm danh{% endblock %} {% block head %}
<style>
  .form-container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 30px;
  }

  .step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
  }

  .step {
    display: flex;
    align-items: center;
    padding: 10px 20px;
    border-radius: 25px;
    margin: 0 10px;
    background: #e9ecef;
    color: #6c757d;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .step.active {
    background: #007bff;
    color: white;
  }

  .step.completed {
    background: #28a745;
    color: white;
  }

  .step i {
    margin-right: 8px;
  }

  .form-section {
    display: none;
  }

  .form-section.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .subject-card,
  .class-card {
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 20px;
    margin: 10px 0;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .subject-card:hover,
  .class-card:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2);
  }

  .subject-card.selected,
  .class-card.selected {
    border-color: #007bff;
    background: rgba(0, 123, 255, 0.1);
  }

  .nav-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
          <i class="fas fa-plus-circle me-2"></i>
          Tạo ca điểm danh mới
        </h2>
        <a href="{{ url_for('attendance.list_sessions') }}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-1"></i>
          Quay lại
        </a>
      </div>
    </div>
  </div>

  <div class="form-container">
    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step active" id="step1-indicator">
        <i class="fas fa-book"></i>
        Chọn môn học
      </div>
      <div class="step" id="step2-indicator">
        <i class="fas fa-users"></i>
        Chọn lớp học
      </div>
      <div class="step" id="step3-indicator">
        <i class="fas fa-calendar"></i>
        Thông tin ca
      </div>
    </div>

    <form method="POST" id="sessionForm">
      <!-- Step 1: Chọn môn học -->
      <div class="form-section active" id="step1">
        <h4 class="mb-4">
          <i class="fas fa-book me-2"></i>
          Chọn môn học
        </h4>

        {% if subjects %}
        <div class="row">
          {% for subject in subjects %}
          <div class="col-md-6">
            <div class="subject-card" data-subject-id="{{ subject.id }}" data-subject-name="{{ subject.subject_name }}" data-subject-code="{{ subject.subject_code }}">
              <h5 class="mb-2">{{ subject.subject_name }}</h5>
              <p class="text-muted mb-0">
                <i class="fas fa-code me-2"></i>
                Mã môn: {{ subject.subject_code }}
              </p>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Chưa có môn học nào.
          <a href="{{ url_for('subjects.add_subject') }}" class="alert-link">Tạo môn học mới</a> trước khi tạo ca điểm danh.
        </div>
        {% endif %}
      </div>

      <!-- Step 2: Chọn lớp học -->
      <div class="form-section" id="step2">
        <h4 class="mb-4">
          <i class="fas fa-users me-2"></i>
          Chọn lớp học cho môn: <span id="selectedSubjectName" class="text-primary"></span>
        </h4>

        <div id="classesContainer">
          {% if classes %}
          <div class="row">
            {% for class in classes %}
            <div class="col-md-6">
              <div class="class-card" data-class-id="{{ class.id }}" data-class-name="{{ class.class_name }}" data-class-code="{{ class.class_code }}">
                <h5 class="mb-2">{{ class.class_name }}</h5>
                <p class="text-muted mb-0">
                  <i class="fas fa-code me-2"></i>
                  Mã lớp: {{ class.class_code }}
                </p>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Chưa có lớp học nào.
            <a href="{{ url_for('classes.add_class') }}" class="alert-link">Tạo lớp học mới</a> trước khi tạo ca điểm danh.
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Step 3: Thông tin ca điểm danh -->
      <div class="form-section" id="step3">
        <h4 class="mb-4">
          <i class="fas fa-calendar me-2"></i>
          Thông tin ca điểm danh
        </h4>

        <div class="row">
          <div class="col-md-12">
            <div class="mb-3">
              <label class="form-label">Tên ca điểm danh *</label>
              <input type="text" class="form-control" name="session_name" required placeholder="Ví dụ: Buổi học tuần 1" />
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Ngày học *</label>
              <input type="date" class="form-control" name="session_date" required />
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Giờ bắt đầu *</label>
              <input type="time" class="form-control" name="start_time" required />
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Giờ kết thúc</label>
              <input type="time" class="form-control" name="end_time" />
            </div>
          </div>
        </div>

        <!-- Summary -->
        <div class="alert alert-info">
          <h6><i class="fas fa-info-circle me-2"></i>Tóm tắt ca điểm danh:</h6>
          <ul class="mb-0">
            <li><strong>Môn học:</strong> <span id="summarySubject"></span></li>
            <li><strong>Lớp học:</strong> <span id="summaryClass"></span></li>
          </ul>
        </div>

        <!-- Hidden inputs -->
        <input type="hidden" name="subject_id" id="selectedSubjectId" />
        <input type="hidden" name="class_id" id="selectedClassId" />
      </div>

      <!-- Navigation buttons -->
      <div class="nav-buttons">
        <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none">
          <i class="fas fa-arrow-left me-1"></i>
          Quay lại
        </button>

        <button type="button" class="btn btn-primary" id="nextBtn">
          Tiếp theo
          <i class="fas fa-arrow-right ms-1"></i>
        </button>

        <button type="submit" class="btn btn-success" id="submitBtn" style="display: none">
          <i class="fas fa-check me-1"></i>
          Tạo ca điểm danh
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let currentStep = 1;
  let selectedSubject = null;
  let selectedClass = null;

  // Step navigation
  document.getElementById("nextBtn").addEventListener("click", function () {
    if (validateCurrentStep()) {
      if (currentStep < 3) {
        currentStep++;
        showStep(currentStep);
      }
    }
  });

  document.getElementById("prevBtn").addEventListener("click", function () {
    if (currentStep > 1) {
      currentStep--;
      showStep(currentStep);
    }
  });

  // Subject selection
  document.querySelectorAll(".subject-card").forEach((card) => {
    card.addEventListener("click", function () {
      // Remove previous selection
      document.querySelectorAll(".subject-card").forEach((c) => c.classList.remove("selected"));

      // Add selection to clicked card
      this.classList.add("selected");

      // Store selected subject
      selectedSubject = {
        id: this.dataset.subjectId,
        name: this.dataset.subjectName,
        code: this.dataset.subjectCode,
      };

      document.getElementById("selectedSubjectId").value = selectedSubject.id;
      document.getElementById("selectedSubjectName").textContent = selectedSubject.name;
      document.getElementById("summarySubject").textContent = `${selectedSubject.name} (${selectedSubject.code})`;
    });
  });

  // Class selection
  document.querySelectorAll(".class-card").forEach((card) => {
    card.addEventListener("click", function () {
      // Remove previous selection
      document.querySelectorAll(".class-card").forEach((c) => c.classList.remove("selected"));

      // Add selection to clicked card
      this.classList.add("selected");

      // Store selected class
      selectedClass = {
        id: this.dataset.classId,
        name: this.dataset.className,
        code: this.dataset.classCode,
      };

      document.getElementById("selectedClassId").value = selectedClass.id;
      document.getElementById("summaryClass").textContent = `${selectedClass.name} (${selectedClass.code})`;
    });
  });

  function showStep(step) {
    // Hide all steps
    document.querySelectorAll(".form-section").forEach((section) => {
      section.classList.remove("active");
    });

    // Show current step
    document.getElementById(`step${step}`).classList.add("active");

    // Update step indicators
    for (let i = 1; i <= 3; i++) {
      const indicator = document.getElementById(`step${i}-indicator`);
      indicator.classList.remove("active", "completed");

      if (i < step) {
        indicator.classList.add("completed");
      } else if (i === step) {
        indicator.classList.add("active");
      }
    }

    // Update navigation buttons
    document.getElementById("prevBtn").style.display = step > 1 ? "block" : "none";
    document.getElementById("nextBtn").style.display = step < 3 ? "block" : "none";
    document.getElementById("submitBtn").style.display = step === 3 ? "block" : "none";
  }

  function validateCurrentStep() {
    if (currentStep === 1) {
      if (!selectedSubject) {
        alert("Vui lòng chọn môn học!");
        return false;
      }
    } else if (currentStep === 2) {
      if (!selectedClass) {
        alert("Vui lòng chọn lớp học!");
        return false;
      }
    }
    return true;
  }

  // Set default date to today
  document.addEventListener("DOMContentLoaded", function () {
    const today = new Date().toISOString().split("T")[0];
    document.querySelector('input[name="session_date"]').value = today;
  });
</script>
{% endblock %}
