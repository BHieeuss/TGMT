{% extends "base.html" %} {% block title %}Điểm danh khuôn mặt{% endblock %} {% block head %}
<style>
  .camera-container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
    padding: 30px;
  }

  .session-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
    text-align: center;
  }

  .video-container {
    position: relative;
    border-radius: 15px;
    overflow: hidden;
    margin-bottom: 30px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
  }

  #video {
    width: 100%;
    height: auto;
    display: block;
  }

  .video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
  }

  .capture-controls {
    text-align: center;
    margin-bottom: 20px;
  }

  .capture-btn {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 4px solid #007bff;
    background: #007bff;
    color: white;
    font-size: 1.5rem;
    margin: 0 10px;
    transition: all 0.3s ease;
  }

  .capture-btn:hover {
    transform: scale(1.1);
    background: #0056b3;
    border-color: #0056b3;
  }

  .capture-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .status-message {
    text-align: center;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    font-weight: 500;
  }

  .status-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .status-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .status-info {
    background: #cce5ff;
    color: #004085;
    border: 1px solid #b3d9ff;
  }

  .attendance-log {
    max-height: 300px;
    overflow-y: auto;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
  }

  .attendance-item {
    display: flex;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #dee2e6;
  }

  .attendance-item:last-child {
    border-bottom: none;
  }

  .attendance-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #007bff;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-weight: bold;
  }

  .loading-spinner {
    display: none;
    text-align: center;
    padding: 20px;
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid py-4">
  <!-- Session Header -->
  <div class="session-header">
    <h2 class="mb-2">
      <i class="fas fa-camera me-2"></i>
      Điểm danh khuôn mặt
    </h2>
    <h4 class="mb-2">{{ session.session_name }}</h4>
    <p class="mb-0 opacity-75">{{ session.subject_name }} - {{ session.class_name }}</p>
  </div>

  <div class="camera-container">
    <!-- Video Stream -->
    <div class="video-container">
      <video id="video" autoplay muted playsinline>
        <source src="" type="" />
        Trình duyệt không hỗ trợ video
      </video>
      <div class="video-overlay" id="videoOverlay">
        <div>
          <i class="fas fa-camera fa-3x mb-3"></i>
          <div>Nhấn "Bắt đầu camera" để điểm danh</div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="capture-controls">
      <button class="btn capture-btn" id="startCameraBtn" onclick="startCamera()">
        <i class="fas fa-video"></i>
      </button>
      <button class="btn capture-btn" id="captureBtn" onclick="captureImage()" disabled>
        <i class="fas fa-camera"></i>
      </button>
      <button class="btn capture-btn btn-danger" id="stopCameraBtn" onclick="stopCamera()" disabled>
        <i class="fas fa-stop"></i>
      </button>
    </div>

    <div class="text-center mb-3">
      <small class="text-muted">
        <i class="fas fa-info-circle me-1"></i>
        Hướng khuôn mặt vào camera và nhấn nút chụp để điểm danh
      </small>
    </div>

    <!-- Status Messages -->
    <div id="statusMessage" class="status-message" style="display: none"></div>

    <!-- Loading -->
    <div class="loading-spinner" id="loadingSpinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="mt-2">Đang xử lý...</div>
    </div>

    <!-- Manual Attendance -->
    <div class="text-center mb-4">
      <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#manualModal">
        <i class="fas fa-edit me-2"></i>
        Điểm danh thủ công
      </button>
      <a href="{{ url_for('attendance.session_detail', session_id=session.id) }}" class="btn btn-outline-secondary ms-2">
        <i class="fas fa-list me-2"></i>
        Xem danh sách
      </a>
    </div>

    <!-- Attendance Log -->
    <div class="attendance-log">
      <h6 class="mb-3">
        <i class="fas fa-history me-2"></i>
        Lịch sử điểm danh hôm nay
      </h6>
      <div id="attendanceList">
        <div class="text-center text-muted">
          <i class="fas fa-clock fa-2x mb-2"></i>
          <div>Chưa có ai điểm danh</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Manual Attendance Modal -->
<div class="modal fade" id="manualModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-edit me-2"></i>
          Điểm danh thủ công
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">MSSV *</label>
          <input type="text" class="form-control" id="manualStudentId" placeholder="Nhập MSSV..." />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" onclick="manualAttendance()">
          <i class="fas fa-check me-1"></i>
          Điểm danh
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let stream;
  let isCapturing = false;
  const sessionId = parseInt('{{ session.id }}');

  async function startCamera() {
      try {
          stream = await navigator.mediaDevices.getUserMedia({
              video: {
                  width: { ideal: 640 },
                  height: { ideal: 480 },
                  facingMode: 'user'
              }
          });

          const video = document.getElementById('video');
          video.srcObject = stream;

          document.getElementById('videoOverlay').style.display = 'none';
          document.getElementById('startCameraBtn').disabled = true;
          document.getElementById('captureBtn').disabled = false;
          document.getElementById('stopCameraBtn').disabled = false;

          showStatus('Camera đã sẵn sàng!', 'info');

      } catch (error) {
          console.error('Lỗi truy cập camera:', error);
          showStatus('Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập.', 'error');
      }
  }

  function stopCamera() {
      if (stream) {
          stream.getTracks().forEach(track => track.stop());
          stream = null;
      }

      document.getElementById('videoOverlay').style.display = 'flex';
      document.getElementById('startCameraBtn').disabled = false;
      document.getElementById('captureBtn').disabled = true;
      document.getElementById('stopCameraBtn').disabled = true;

      showStatus('Camera đã tắt', 'info');
  }

  async function captureImage() {
      if (isCapturing) return;

      isCapturing = true;
      document.getElementById('captureBtn').disabled = true;
      document.getElementById('loadingSpinner').style.display = 'block';

      try {
          const video = document.getElementById('video');
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0);

          const imageData = canvas.toDataURL('image/jpeg', 0.8);

          // Send to server for face recognition
          const response = await fetch('/attendance/api/recognize_face', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  session_id: sessionId,
                  image: imageData
              })
          });

          const result = await response.json();

          if (result.success) {
              showStatus(result.message, 'success');
              addToAttendanceLog(result.student);
              loadAttendanceLog(); // Refresh the log
          } else {
              showStatus(result.message, 'error');
          }

      } catch (error) {
          console.error('Lỗi điểm danh:', error);
          showStatus('Có lỗi xảy ra khi điểm danh', 'error');
      } finally {
          isCapturing = false;
          document.getElementById('captureBtn').disabled = false;
          document.getElementById('loadingSpinner').style.display = 'none';
      }
  }

  async function manualAttendance() {
      const studentId = document.getElementById('manualStudentId').value.trim();

      if (!studentId) {
          alert('Vui lòng nhập MSSV!');
          return;
      }

      try {
          const response = await fetch('/attendance/api/manual_attendance', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  session_id: sessionId,
                  student_id: studentId
              })
          });

          const result = await response.json();

          if (result.success) {
              showStatus(result.message, 'success');
              document.getElementById('manualStudentId').value = '';

              // Close modal
              const modal = bootstrap.Modal.getInstance(document.getElementById('manualModal'));
              modal.hide();

              // Refresh attendance log
              loadAttendanceLog();
          } else {
              alert('Lỗi: ' + result.message);
          }

      } catch (error) {
          alert('Có lỗi xảy ra: ' + error);
      }
  }

  function showStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.className = `status-message status-${type}`;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';

      setTimeout(() => {
          statusDiv.style.display = 'none';
      }, 5000);
  }

  function addToAttendanceLog(student) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString();

      const attendanceList = document.getElementById('attendanceList');
      if (attendanceList.innerHTML.includes('Chưa có ai điểm danh')) {
          attendanceList.innerHTML = '';
      }

      const item = document.createElement('div');
      item.className = 'attendance-item';
      item.innerHTML = `
          <div class="attendance-avatar">
              ${student.name.charAt(0).toUpperCase()}
          </div>
          <div class="flex-grow-1">
              <div class="fw-bold">${student.name}</div>
              <small class="text-muted">${student.id} - ${timeStr}</small>
          </div>
          <div class="text-success">
              <i class="fas fa-check-circle"></i>
          </div>
      `;

      attendanceList.insertBefore(item, attendanceList.firstChild);
  }

  async function loadAttendanceLog() {
      try {
          const response = await fetch(`/attendance/api/session_attendance/${sessionId}`);
          const attendances = await response.json();

          const attendanceList = document.getElementById('attendanceList');

          if (attendances.length === 0) {
              attendanceList.innerHTML = `
                  <div class="text-center text-muted">
                      <i class="fas fa-clock fa-2x mb-2"></i>
                      <div>Chưa có ai điểm danh</div>
                  </div>
              `;
              return;
          }

          attendanceList.innerHTML = attendances.map(att => `
              <div class="attendance-item">
                  <div class="attendance-avatar">
                      ${att.full_name.charAt(0).toUpperCase()}
                  </div>
                  <div class="flex-grow-1">
                      <div class="fw-bold">${att.full_name}</div>
                      <small class="text-muted">${att.student_id} - ${new Date(att.attendance_time).toLocaleTimeString()}</small>
                  </div>
                  <div class="text-success">
                      <i class="fas fa-${att.method === 'face_recognition' ? 'camera' : 'edit'}"></i>
                  </div>
              </div>
          `).join('');

      } catch (error) {
          console.error('Lỗi tải danh sách điểm danh:', error);
      }
  }

  // Load attendance log on page load
  document.addEventListener('DOMContentLoaded', function() {
      loadAttendanceLog();
  });

  // Cleanup when leaving page
  window.addEventListener('beforeunload', function() {
      stopCamera();
  });
</script>
{% endblock %}
