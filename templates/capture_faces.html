{% extends "base.html" %} {% block title %}Thu thập dữ liệu khuôn mặt{% endblock %} {% block head %}
<style>
  .camera-container {
    position: relative;
    max-width: 640px;
    margin: 0 auto;
  }

  #video {
    width: 100%;
    height: auto;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  }

  .capture-btn {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 4px solid white;
    background: #28a745;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .capture-btn:hover {
    background: #218838;
    transform: translateX(-50%) scale(1.1);
  }

  .capture-btn:active {
    transform: translateX(-50%) scale(0.95);
  }

  .face-detection-overlay {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
  }

  .face-box {
    position: absolute;
    border: 3px solid #28a745;
    border-radius: 5px;
    background: rgba(40, 167, 69, 0.1);
  }

  .student-info {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 30px;
  }
</style>
{% endblock %} {% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2"><i class="fas fa-camera me-2"></i>Thu thập dữ liệu khuôn mặt</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <a href="{{ url_for('students.list_students') }}" class="btn btn-outline-secondary"> <i class="fas fa-arrow-left me-1"></i>Quay lại </a>
  </div>
</div>

<!-- Student Selection -->
<div class="student-info">
  <div class="row align-items-center">
    <div class="col-md-8">
      <div class="mb-3">
        <label for="studentSelect" class="form-label h5 mb-3"> <i class="fas fa-user-graduate me-2"></i>Chọn sinh viên: </label>
        <select class="form-select form-select-lg" id="studentSelect">
          <option value="">-- Chọn sinh viên --</option>
        </select>
      </div>
    </div>
    <div class="col-md-4 text-end">
      <button class="btn btn-light btn-lg" onclick="loadStudents()"><i class="fas fa-sync-alt me-2"></i>Làm mới</button>
    </div>
  </div>
</div>

<div class="row">
  <!-- Camera Section -->
  <div class="col-lg-8">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-video me-2"></i>Camera thu thập dữ liệu</h5>
      </div>
      <div class="card-body text-center">
        <div class="camera-container">
          <video id="video" autoplay muted playsinline></video>
          <canvas id="canvas" style="display: none"></canvas>
          <canvas id="overlay" class="face-detection-overlay"></canvas>
          <div class="capture-btn" id="captureBtn" onclick="captureImage()" style="display: none">
            <i class="fas fa-camera fa-2x text-white"></i>
          </div>
        </div>

        <div class="mt-3">
          <button class="btn btn-success btn-lg me-2" id="startCamera" onclick="startCamera()"><i class="fas fa-play me-2"></i>Bật camera</button>
          <button class="btn btn-danger btn-lg" id="stopCamera" onclick="stopCamera()" style="display: none"><i class="fas fa-stop me-2"></i>Tắt camera</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Instructions & Results -->
  <div class="col-lg-4">
    <!-- Instructions -->
    <div class="card shadow mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Hướng dẫn</h5>
      </div>
      <div class="card-body">
        <ol class="mb-0">
          <li>Chọn sinh viên cần thu thập dữ liệu</li>
          <li>Bật camera</li>
          <li>Đặt khuôn mặt vào khung hình</li>
          <li>Đảm bảo ánh sáng đủ và rõ ràng</li>
          <li>Nhấn nút chụp khi sẵn sàng</li>
        </ol>

        <div class="alert alert-warning mt-3 mb-0">
          <small>
            <i class="fas fa-exclamation-triangle me-1"></i>
            <strong>Lưu ý:</strong> Khuôn mặt phải hướng thẳng về camera và không bị che khuất
          </small>
        </div>
      </div>
    </div>

    <!-- Capture Result -->
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Kết quả thu thập</h5>
      </div>
      <div class="card-body">
        <div id="captureResult" style="min-height: 100px; display: flex; align-items: center; justify-content: center">
          <div class="text-muted text-center">
            <i class="fas fa-info-circle fa-2x mb-3"></i>
            <p>Chọn sinh viên và bật camera để bắt đầu</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Captured Faces Gallery -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-images me-2"></i>Dữ liệu đã thu thập</h5>
      </div>
      <div class="card-body">
        <div id="capturedFaces" class="row">
          <div class="col-12 text-center text-muted py-4">
            <i class="fas fa-image fa-3x mb-3"></i>
            <p>Chưa có dữ liệu khuôn mặt nào được thu thập</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  let video = document.getElementById("video");
  let canvas = document.getElementById("canvas");
  let overlay = document.getElementById("overlay");
  let currentStream = null;
  let currentStudentId = null;
  let faceDetectionInterval = null;

  // Load students for selection
  async function loadStudents() {
    try {
      const response = await fetch("/students/api/all");
      const students = await response.json();

      const select = document.getElementById("studentSelect");
      select.innerHTML = '<option value="">-- Chọn sinh viên --</option>';

      students.forEach((student) => {
        const option = document.createElement("option");
        option.value = student.student_id;
        option.textContent = `${student.student_id} - ${student.full_name}`;
        select.appendChild(option);
      });
    } catch (error) {
      console.error("Error loading students:", error);
      showMessage("Lỗi khi tải danh sách sinh viên", "error");
    }
  }

  // Handle student selection
  document.getElementById("studentSelect").addEventListener("change", function () {
    currentStudentId = this.value;
    if (currentStudentId) {
      document.getElementById("captureResult").innerHTML = `
            <div class="text-success text-center">
                <i class="fas fa-user fa-2x mb-3"></i>
                <p>Đã chọn sinh viên ${this.options[this.selectedIndex].text}</p>
                <small>Bật camera để bắt đầu thu thập</small>
            </div>
        `;
    } else {
      document.getElementById("captureResult").innerHTML = `
            <div class="text-muted text-center">
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <p>Chọn sinh viên và bật camera để bắt đầu</p>
            </div>
        `;
    }
  });

  // Start camera
  async function startCamera() {
    try {
      currentStream = await navigator.mediaDevices.getUserMedia({
        video: {
          width: { ideal: 640 },
          height: { ideal: 480 },
          facingMode: "user",
        },
      });
      video.srcObject = currentStream;

      document.getElementById("startCamera").style.display = "none";
      document.getElementById("stopCamera").style.display = "inline-block";
      document.getElementById("captureBtn").style.display = "block";

      // Setup overlay canvas
      overlay.width = video.videoWidth || 640;
      overlay.height = video.videoHeight || 480;

      // Start face detection
      startFaceDetection();

      showMessage("Camera đã được bật", "success");
    } catch (error) {
      console.error("Error accessing camera:", error);
      showMessage("Không thể truy cập camera", "error");
    }
  }

  // Stop camera
  function stopCamera() {
    if (currentStream) {
      currentStream.getTracks().forEach((track) => track.stop());
      currentStream = null;
      video.srcObject = null;

      document.getElementById("startCamera").style.display = "inline-block";
      document.getElementById("stopCamera").style.display = "none";
      document.getElementById("captureBtn").style.display = "none";

      // Stop face detection
      if (faceDetectionInterval) {
        clearInterval(faceDetectionInterval);
        faceDetectionInterval = null;
      }

      // Clear overlay
      const ctx = overlay.getContext("2d");
      ctx.clearRect(0, 0, overlay.width, overlay.height);

      showMessage("Camera đã được tắt", "info");
    }
  }

  // Start face detection
  function startFaceDetection() {
    faceDetectionInterval = setInterval(async () => {
      if (video.videoWidth > 0 && video.videoHeight > 0) {
        await detectFaces();
      }
    }, 500); // Check every 500ms
  }

  // Detect faces and draw overlay
  async function detectFaces() {
    try {
      // Capture current frame
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);

      // Get image data
      const imageData = canvas.toDataURL("image/jpeg", 0.8);

      // Call face detection API
      const response = await fetch("/api/detect_face", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image: imageData }),
      });

      const result = await response.json();

      // Update overlay
      const overlayCtx = overlay.getContext("2d");
      overlayCtx.clearRect(0, 0, overlay.width, overlay.height);

      if (result.success && result.face_count > 0) {
        // Draw face detection indicator (simplified)
        overlayCtx.strokeStyle = "#28a745";
        overlayCtx.lineWidth = 3;
        overlayCtx.strokeRect(overlay.width * 0.25, overlay.height * 0.25, overlay.width * 0.5, overlay.height * 0.5);
      }
    } catch (error) {
      // Silently handle detection errors
    }
  }

  // Capture image for face data collection
  async function captureImage() {
    if (!currentStudentId) {
      showMessage("Vui lòng chọn sinh viên trước", "warning");
      return;
    }

    if (!currentStream) {
      showMessage("Vui lòng bật camera trước", "warning");
      return;
    }

    // Capture frame from video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    // Convert to base64
    const imageData = canvas.toDataURL("image/jpeg", 0.8);

    // Show loading
    document.getElementById("captureResult").innerHTML = `
        <div class="text-primary text-center">
            <div class="spinner-border mb-3" role="status"></div>
            <p>Đang thu thập dữ liệu khuôn mặt...</p>
        </div>
    `;

    try {
      const response = await fetch("/api/capture_face", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          student_id: currentStudentId,
          image: imageData,
        }),
      });

      const result = await response.json();

      if (result.success) {
        document.getElementById("captureResult").innerHTML = `
                <div class="text-success text-center">
                    <i class="fas fa-check-circle fa-3x mb-3"></i>
                    <h6>${result.student.name}</h6>
                    <p>MSSV: ${result.student.id}</p>
                    <small>Thu thập thành công</small>
                </div>
            `;
        showMessage(result.message, "success");
        loadCapturedFaces();
      } else {
        document.getElementById("captureResult").innerHTML = `
                <div class="text-danger text-center">
                    <i class="fas fa-times-circle fa-3x mb-3"></i>
                    <p>${result.message}</p>
                </div>
            `;
        showMessage(result.message, "error");
      }
    } catch (error) {
      console.error("Error capturing face:", error);
      document.getElementById("captureResult").innerHTML = `
            <div class="text-danger text-center">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <p>Lỗi kết nối server</p>
            </div>
        `;
      showMessage("Lỗi khi thu thập dữ liệu khuôn mặt", "error");
    }
  }

  // Load captured faces
  async function loadCapturedFaces() {
    try {
      const response = await fetch("/students/api/captured_faces");
      const faces = await response.json();

      const container = document.getElementById("capturedFaces");

      if (faces.length > 0) {
        let html = "";
        faces.forEach((face) => {
          html += `
                    <div class="col-md-3 mb-3">
                        <div class="card">
                            <img src="/uploads/${face.face_file}" class="card-img-top" style="height: 200px; object-fit: cover;">
                            <div class="card-body text-center p-2">
                                <h6 class="card-title mb-1">${face.student_id}</h6>
                                <small class="text-muted">${face.full_name}</small>
                            </div>
                        </div>
                    </div>
                `;
        });
        container.innerHTML = html;
      } else {
        container.innerHTML = `
                <div class="col-12 text-center text-muted py-4">
                    <i class="fas fa-image fa-3x mb-3"></i>
                    <p>Chưa có dữ liệu khuôn mặt nào được thu thập</p>
                </div>
            `;
      }
    } catch (error) {
      console.error("Error loading captured faces:", error);
    }
  }

  // Show message
  function showMessage(message, type) {
    const alertClass = type === "error" ? "danger" : type;
    const alert = document.createElement("div");
    alert.className = `alert alert-${alertClass} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    const container = document.querySelector(".container-fluid");
    container.insertBefore(alert, container.firstChild);

    setTimeout(() => {
      if (alert.parentNode) {
        alert.remove();
      }
    }, 5000);
  }

  // Initialize
  document.addEventListener("DOMContentLoaded", function () {
    loadStudents();
    loadCapturedFaces();
  });

  // Cleanup on page unload
  window.addEventListener("beforeunload", function () {
    if (currentStream) {
      currentStream.getTracks().forEach((track) => track.stop());
    }
    if (faceDetectionInterval) {
      clearInterval(faceDetectionInterval);
    }
  });
</script>
{% endblock %}
