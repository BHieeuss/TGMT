{% extends "base.html" %} {% block title %}Điểm danh Camera - Hệ thống điểm danh khuôn mặt{% endblock %} {% block head %}
<style>
  .camera-container {
    position: relative;
    max-width: 640px;
    margin: 0 auto;
  }

  #video {
    width: 100%;
    height: auto;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  }

  .camera-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
  }

  .face-detection-box {
    position: absolute;
    border: 3px solid #28a745;
    border-radius: 5px;
    background: rgba(40, 167, 69, 0.1);
  }

  .capture-btn {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 4px solid white;
    background: #dc3545;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .capture-btn:hover {
    background: #c82333;
    transform: translateX(-50%) scale(1.1);
  }

  .capture-btn:active {
    transform: translateX(-50%) scale(0.95);
  }

  .attendance-result {
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .session-selector {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 30px;
  }
</style>
{% endblock %} {% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2"><i class="fas fa-camera me-2"></i>Điểm danh bằng Camera</h1>
</div>

<!-- Session Selection -->
<div class="session-selector">
  <div class="row align-items-center">
    <div class="col-md-8">
      <div class="mb-3">
        <label for="sessionSelect" class="form-label h5 mb-3"> <i class="fas fa-calendar-check me-2"></i>Chọn ca điểm danh: </label>
        <select class="form-select form-select-lg" id="sessionSelect">
          <option value="">-- Chọn ca điểm danh --</option>
        </select>
      </div>
    </div>
    <div class="col-md-4 text-end">
      <button class="btn btn-light btn-lg" onclick="loadSessions()"><i class="fas fa-sync-alt me-2"></i>Làm mới</button>
    </div>
  </div>
</div>

<div class="row">
  <!-- Camera Section -->
  <div class="col-lg-8">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-video me-2"></i>Camera điểm danh</h5>
      </div>
      <div class="card-body text-center">
        <div class="camera-container">
          <video id="video" autoplay muted playsinline></video>
          <canvas id="canvas" style="display: none"></canvas>
          <div class="camera-overlay">
            <div class="capture-btn" id="captureBtn" onclick="captureImage()">
              <i class="fas fa-camera fa-2x text-white"></i>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <button class="btn btn-success btn-lg me-2" id="startCamera" onclick="startCamera()"><i class="fas fa-play me-2"></i>Bật camera</button>
          <button class="btn btn-danger btn-lg" id="stopCamera" onclick="stopCamera()" style="display: none"><i class="fas fa-stop me-2"></i>Tắt camera</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Control Panel -->
  <div class="col-lg-4">
    <!-- Manual Attendance -->
    <div class="card shadow mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-keyboard me-2"></i>Điểm danh thủ công</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="studentId" class="form-label">MSSV:</label>
          <input type="text" class="form-control" id="studentId" placeholder="Nhập MSSV" />
        </div>
        <button class="btn btn-primary w-100" onclick="manualAttendance()"><i class="fas fa-check me-2"></i>Điểm danh</button>
      </div>
    </div>

    <!-- Attendance Result -->
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-list-check me-2"></i>Kết quả điểm danh</h5>
      </div>
      <div class="card-body">
        <div id="attendanceResult" class="attendance-result">
          <div class="text-muted">
            <i class="fas fa-info-circle fa-2x mb-3"></i>
            <p>Chọn ca điểm danh để bắt đầu</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recent Attendance for Current Session -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-users-check me-2"></i>Danh sách đã điểm danh</h5>
      </div>
      <div class="card-body">
        <div id="attendanceList">
          <div class="text-center text-muted py-4">
            <i class="fas fa-clipboard-list fa-3x mb-3"></i>
            <p>Chưa có sinh viên nào điểm danh</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  let video = document.getElementById("video");
  let canvas = document.getElementById("canvas");
  let currentStream = null;
  let currentSessionId = null;

  // Load available sessions
  async function loadSessions() {
    try {
      const response = await fetch("/attendance/api/active_sessions");
      const sessions = await response.json();

      const select = document.getElementById("sessionSelect");
      select.innerHTML = '<option value="">-- Chọn ca điểm danh --</option>';

      sessions.forEach((session) => {
        const option = document.createElement("option");
        option.value = session.id;
        option.textContent = `${session.session_name} - ${session.subject_name} - ${session.class_name}`;
        select.appendChild(option);
      });
    } catch (error) {
      console.error("Error loading sessions:", error);
      showMessage("Lỗi khi tải danh sách ca điểm danh", "error");
    }
  }

  // Handle session selection
  document.getElementById("sessionSelect").addEventListener("change", function () {
    currentSessionId = this.value;
    if (currentSessionId) {
      loadAttendanceList();
      document.getElementById("attendanceResult").innerHTML = `
            <div class="text-success">
                <i class="fas fa-check-circle fa-2x mb-3"></i>
                <p>Đã chọn ca điểm danh. Sẵn sàng nhận diện!</p>
            </div>
        `;
    } else {
      document.getElementById("attendanceResult").innerHTML = `
            <div class="text-muted">
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <p>Chọn ca điểm danh để bắt đầu</p>
            </div>
        `;
    }
  });

  // Start camera
  async function startCamera() {
    try {
      currentStream = await navigator.mediaDevices.getUserMedia({
        video: {
          width: 640,
          height: 480,
          facingMode: "user",
        },
      });
      video.srcObject = currentStream;

      document.getElementById("startCamera").style.display = "none";
      document.getElementById("stopCamera").style.display = "inline-block";
      document.getElementById("captureBtn").style.display = "block";

      showMessage("Camera đã được bật", "success");
    } catch (error) {
      console.error("Error accessing camera:", error);
      showMessage("Không thể truy cập camera", "error");
    }
  }

  // Stop camera
  function stopCamera() {
    if (currentStream) {
      currentStream.getTracks().forEach((track) => track.stop());
      currentStream = null;
      video.srcObject = null;

      document.getElementById("startCamera").style.display = "inline-block";
      document.getElementById("stopCamera").style.display = "none";
      document.getElementById("captureBtn").style.display = "none";

      showMessage("Camera đã được tắt", "info");
    }
  }

  // Capture image for face recognition
  async function captureImage() {
    if (!currentSessionId) {
      showMessage("Vui lòng chọn ca điểm danh trước", "warning");
      return;
    }

    if (!currentStream) {
      showMessage("Vui lòng bật camera trước", "warning");
      return;
    }

    // Capture frame from video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    // Convert to base64
    const imageData = canvas.toDataURL("image/jpeg", 0.8);

    // Show loading
    document.getElementById("attendanceResult").innerHTML = `
        <div class="text-primary">
            <div class="spinner-border mb-3" role="status"></div>
            <p>Đang nhận diện khuôn mặt...</p>
        </div>
    `;

    try {
      const response = await fetch("/attendance/api/recognize_face", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          session_id: currentSessionId,
          image: imageData,
        }),
      });

      const result = await response.json();

      if (result.success) {
        document.getElementById("attendanceResult").innerHTML = `
                <div class="text-success">
                    <i class="fas fa-check-circle fa-3x mb-3"></i>
                    <h5>${result.student.name}</h5>
                    <p>MSSV: ${result.student.id}</p>
                    <small>Độ tin cậy: ${result.student.confidence}%</small>
                </div>
            `;
        loadAttendanceList();
        showMessage(result.message, "success");
      } else {
        document.getElementById("attendanceResult").innerHTML = `
                <div class="text-danger">
                    <i class="fas fa-times-circle fa-3x mb-3"></i>
                    <p>${result.message}</p>
                </div>
            `;
        showMessage(result.message, "error");
      }
    } catch (error) {
      console.error("Error recognizing face:", error);
      document.getElementById("attendanceResult").innerHTML = `
            <div class="text-danger">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <p>Lỗi kết nối server</p>
            </div>
        `;
      showMessage("Lỗi khi nhận diện khuôn mặt", "error");
    }
  }

  // Manual attendance
  async function manualAttendance() {
    const studentId = document.getElementById("studentId").value.trim();

    if (!currentSessionId) {
      showMessage("Vui lòng chọn ca điểm danh trước", "warning");
      return;
    }

    if (!studentId) {
      showMessage("Vui lòng nhập MSSV", "warning");
      return;
    }

    try {
      const response = await fetch("/attendance/api/manual_attendance", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          session_id: currentSessionId,
          student_id: studentId,
        }),
      });

      const result = await response.json();

      if (result.success) {
        document.getElementById("attendanceResult").innerHTML = `
                <div class="text-success">
                    <i class="fas fa-check-circle fa-3x mb-3"></i>
                    <h5>${result.student.name}</h5>
                    <p>MSSV: ${result.student.id}</p>
                    <small>Điểm danh thủ công</small>
                </div>
            `;
        document.getElementById("studentId").value = "";
        loadAttendanceList();
        showMessage(result.message, "success");
      } else {
        showMessage(result.message, "error");
      }
    } catch (error) {
      console.error("Error manual attendance:", error);
      showMessage("Lỗi khi điểm danh thủ công", "error");
    }
  }

  // Load attendance list for current session
  async function loadAttendanceList() {
    if (!currentSessionId) return;

    try {
      const response = await fetch(`/attendance/api/session_attendance/${currentSessionId}`);
      const attendance = await response.json();

      const listContainer = document.getElementById("attendanceList");

      if (attendance.length > 0) {
        let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>MSSV</th><th>Họ tên</th><th>Thời gian</th><th>Phương thức</th></tr></thead><tbody>';

        attendance.forEach((record) => {
          const method = record.method === "face_recognition" ? "Nhận diện" : "Thủ công";
          const time = new Date(record.attendance_time).toLocaleTimeString("vi-VN");
          html += `<tr><td>${record.student_id}</td><td>${record.full_name}</td><td>${time}</td><td><span class="badge bg-${record.method === "face_recognition" ? "success" : "primary"}">${method}</span></td></tr>`;
        });

        html += "</tbody></table></div>";
        listContainer.innerHTML = html;
      } else {
        listContainer.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                    <p>Chưa có sinh viên nào điểm danh</p>
                </div>
            `;
      }
    } catch (error) {
      console.error("Error loading attendance list:", error);
    }
  }

  // Show message
  function showMessage(message, type) {
    const alertClass = type === "error" ? "danger" : type;
    const alert = document.createElement("div");
    alert.className = `alert alert-${alertClass} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Insert at top of container
    const container = document.querySelector(".container-fluid");
    container.insertBefore(alert, container.firstChild);

    // Auto dismiss after 5 seconds
    setTimeout(() => {
      if (alert.parentNode) {
        alert.remove();
      }
    }, 5000);
  }

  // Initialize
  document.addEventListener("DOMContentLoaded", function () {
    loadSessions();

    // Auto-refresh sessions every 30 seconds
    setInterval(loadSessions, 30000);
  });

  // Cleanup on page unload
  window.addEventListener("beforeunload", function () {
    if (currentStream) {
      currentStream.getTracks().forEach((track) => track.stop());
    }
  });
</script>
{% endblock %}
